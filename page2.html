<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Digital Register</title>
<style>
body{font-family:Arial;background:#eef;margin:0}
.top{position:sticky;top:0;z-index:10;background:#eef;padding:10px}
.box{background:#fff;padding:15px;border-radius:10px}
input,select,button{width:100%;padding:8px;margin-top:6px}
.save{background:#1976d2;color:#fff;border:none}
.logout{background:#e53935;color:#fff;border:none}
.add{background:#2ecc71;color:#fff;border:none}
.wrap{max-height:300px;overflow-y:auto;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #aaa;padding:5px;text-align:center;font-size:14px}
.small{font-weight:bold;margin-top:6px}
</style>
</head>
<body>

<script>
if(localStorage.login!=="yes"){ location.replace("index.html"); }
</script>

<div class="top">
<div class="box">
<button class="logout" onclick="logout()">Logout</button>
<h3 style="text-align:center">Digital Register</h3>

<label>Month</label><input type="month" id="month">
<label>Date</label><input type="date" id="date">

<label>Shift</label>
<select id="shift"><option>Day</option><option>Night</option></select>

<label>Post</label>
<select id="post"></select>
<input id="newPost" placeholder="Add Post">
<button class="add" onclick="addPost()">Add Post</button>

<label>Signature</label>
<select id="sign"><option>Ravi</option></select>

<label>Row Font Color</label>
<input type="color" id="color" value="#000000">

<button class="save" onclick="save()">Save (Cloud)</button>
<div class="small" id="count"></div>
</div>
</div>

<div class="wrap">
<table>
<thead><tr>
<th>Date</th><th>Shift</th><th>Post</th><th>Sign</th><th>Edit</th><th>Del</th>
</tr></thead>
<tbody id="tb"></tbody>
</table>
</div>

<button class="save" onclick="download()">Download CSV</button>

<script>
/* GOOGLE FORM (REPLACE THESE) */
const FORM_ACTION_URL="https://docs.google.com/forms/d/e/FORM_ID/formResponse";
/* Replace entry IDs below */
const E_MONTH="entry.MONTH_ID";
const E_DATE ="entry.DATE_ID";
const E_SHIFT="entry.SHIFT_ID";
const E_POST ="entry.POST_ID";
const E_SIGN ="entry.SIGN_ID";

/* POSTS */
let posts=JSON.parse(localStorage.posts||'["ETP","ACL","COE"]');
function loadPosts(){ post.innerHTML=""; posts.forEach(p=>post.innerHTML+=`<option>${p}</option>`); }
function addPost(){
  if(newPost.value){ posts.push(newPost.value); localStorage.posts=JSON.stringify(posts);
    newPost.value=""; loadPosts(); }
}
loadPosts();

/* LOCAL PREVIEW DB */
let db=JSON.parse(localStorage.db||"{}");
let editIndex=null;
const key=()=>month.value;

function save(){
  if(!month.value||!date.value) return alert("Month & Date select kare");
  if(date.value.slice(0,7)!==month.value) return alert("Date selected month ke bahar");

  /* 1) SAVE TO GOOGLE FORM (CLOUD) */
  const params=new URLSearchParams({
    [E_MONTH]:month.value,
    [E_DATE]:date.value,
    [E_SHIFT]:shift.value,
    [E_POST]:post.value,
    [E_SIGN]:sign.value
  });
  fetch(FORM_ACTION_URL+"?"+params.toString(),{method:"GET",mode:"no-cors"})
    .then(()=>alert("✅ Cloud me save ho gaya"))
    .catch(()=>alert("❌ Internet issue"));

  /* 2) LOCAL PREVIEW (SAFE FOR REFRESH) */
  db[key()] = db[key()] || [];
  const obj={d:date.value,s:shift.value,p:post.value,g:sign.value,c:color.value};
  if(editIndex!==null){ db[key()][editIndex]=obj; editIndex=null; }
  else db[key()].push(obj);
  localStorage.db=JSON.stringify(db);
  draw();
}

function draw(){
  const arr=(db[key()]||[]).sort((a,b)=>a.d.localeCompare(b.d));
  tb.innerHTML=""; let day=0,night=0;
  arr.forEach((r,i)=>{
    if(r.s==="Day") day++; else night++;
    tb.innerHTML+=`
      <tr style="color:${r.c}">
        <td>${r.d}</td><td>${r.s}</td><td>${r.p}</td><td>${r.g}</td>
        <td><button onclick="editRow(${i})">Edit</button></td>
        <td><button onclick="delRow(${i})">X</button></td>
      </tr>`;
  });
  count.textContent=`Day: ${day} | Night: ${night} | Total: ${day+night}`;
}
function editRow(i){
  const r=db[key()][i];
  date.value=r.d; shift.value=r.s; post.value=r.p; color.value=r.c; editIndex=i;
}
function delRow(i){
  if(confirm("Delete karna hai?")){
    db[key()].splice(i,1); localStorage.db=JSON.stringify(db); draw();
  }
}
function download(){
  const arr=db[key()]||[];
  let csv="Date,Shift,Post,Signature\n";
  arr.forEach(r=>csv+=`${r.d},${r.s},${r.p},${r.g}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="register_"+month.value+".csv"; a.click();
}
function logout(){
  if(confirm("Logout?")){ localStorage.removeItem("login"); location.replace("index.html"); }
}
month.value=new Date().toISOString().slice(0,7);
draw();
</script>
</body>
</html>
