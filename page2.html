<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Digital Register</title>

<style>
body{font-family:Arial;background:#eef;margin:0}
.form-box{
  position:sticky;top:0;z-index:10;
  background:#eef;padding:10px
}
.box{background:#fff;padding:15px;border-radius:10px}
input,select,button{width:100%;padding:8px;margin:5px 0}
.save{background:#1976d2;color:#fff}
.logout{background:#e53935;color:#fff}
.add{background:#2ecc71;color:#fff}
.table-box{max-height:320px;overflow-y:auto;margin-top:10px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #aaa;padding:5px;text-align:center}
</style>
</head>

<body>

<script>
if(localStorage.getItem("login")!=="yes"){
  location.replace("index.html");
}
</script>

<div class="form-box">
<div class="box">

<button class="logout" onclick="logout()">Logout</button>

<input type="month" id="month">

<input type="date" id="date">

<select id="shift">
  <option>Day</option>
  <option>Night</option>
</select>

<select id="post"></select>
<input id="newPost" placeholder="Add Post">
<button class="add" onclick="addPost()">Add Post</button>

<select id="sign"></select>
<input id="newSign" placeholder="Add Signature">
<button class="add" onclick="addSign()">Add Signature</button>

<label>Row Font Color</label>
<input type="color" id="color" value="#000000">

<button class="save" onclick="save()">Save</button>

<p id="count"></p>
</div>
</div>

<div class="table-box">
<table>
<thead>
<tr>
<th>Date</th><th>Shift</th><th>Post</th><th>Sign</th><th>Edit</th><th>Del</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
</div>

<button onclick="download()">Download CSV</button>

<script>
let editIndex=null;
let posts=JSON.parse(localStorage.getItem("posts")||'["ETP"]');
let signs=JSON.parse(localStorage.getItem("signs")||'["Ravi"]');

function loadSel(){
  post.innerHTML=posts.map(p=>`<option>${p}</option>`).join("");
  sign.innerHTML=signs.map(s=>`<option>${s}</option>`).join("");
}
loadSel();

function addPost(){
  if(newPost.value){
    posts.push(newPost.value);
    localStorage.setItem("posts",JSON.stringify(posts));
    newPost.value="";loadSel();
  }
}
function addSign(){
  if(newSign.value){
    signs.push(newSign.value);
    localStorage.setItem("signs",JSON.stringify(signs));
    newSign.value="";loadSel();
  }
}

function key(){return "DATA_"+month.value;}

function save(){
  if(!date.value){alert("Date select kare");return;}
  if(month.value!==date.value.slice(0,7)){
    alert("Selected month ke bahar date allowed nahi");
    return;
  }

  let d=JSON.parse(localStorage.getItem(key())||"[]");
  let obj={dt:date.value,sh:shift.value,p:post.value,s:sign.value,c:color.value};

  if(editIndex!==null){
    d[editIndex]=obj;
    editIndex=null;
  }else{
    d.push(obj);
  }

  d.sort((a,b)=>new Date(a.dt)-new Date(b.dt));
  localStorage.setItem(key(),JSON.stringify(d));
  show();
}

function formatDate(d){
  let x=new Date(d);
  return String(x.getDate()).padStart(2,"0")+"/"+
         String(x.getMonth()+1).padStart(2,"0")+"/"+
         x.getFullYear();
}

function show(){
  let d=JSON.parse(localStorage.getItem(key())||"[]");
  tb.innerHTML="";
  let day=0,night=0;

  d.forEach((x,i)=>{
    if(x.sh==="Day")day++; else night++;
    tb.innerHTML+=`
    <tr style="color:${x.c}">
      <td>${formatDate(x.dt)}</td>
      <td>${x.sh}</td>
      <td>${x.p}</td>
      <td>${x.s}</td>
      <td><button onclick="edit(${i})">Edit</button></td>
      <td><button style="background:red;color:#fff"
          onclick="delRow(${i})">X</button></td>
    </tr>`;
  });

  count.innerHTML=`Day: ${day} | Night: ${night} | Total: ${day+night}`;
}

function edit(i){
  let d=JSON.parse(localStorage.getItem(key()));
  let x=d[i];
  date.value=x.dt;shift.value=x.sh;
  post.value=x.p;sign.value=x.s;color.value=x.c;
  editIndex=i;
}

function delRow(i){
  if(confirm("Delete karna hai?")){
    let d=JSON.parse(localStorage.getItem(key()));
    d.splice(i,1);
    localStorage.setItem(key(),JSON.stringify(d));
    show();
  }
}

function download(){
  let d=JSON.parse(localStorage.getItem(key())||"[]");
  let csv="Date,Shift,Post,Sign\n";
  d.forEach(x=>csv+=`${x.dt},${x.sh},${x.p},${x.s}\n`);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download=month.value+".csv";
  a.click();
}

function logout(){
  if(confirm("Logout karna hai?")){
    localStorage.removeItem("login");
    location.replace("index.html");
  }
}

month.value=new Date().toISOString().slice(0,7);
show();
</script>

</body>
</html>
