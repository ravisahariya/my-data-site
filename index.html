<div class="footer">
Total Duty: <span id="duty">0</span>
&nbsp;&nbsp;
Total Hours: <span id="hours">0</span>
</div>

</div>



<script>
/* LOGIN */
if(localStorage.login) show();

function login(){
if(username.value==="Ravi" && password.value==="Ravi123"){
localStorage.login=1;
show();
}else alert("Wrong login");
}
function logout(){
localStorage.removeItem("login");
location.reload();
}
function show(){
loginPage.style.display="none";
app.style.display="flex";
}
function secret(){
if(prompt("Enter year")==="1995")
alert("Username: Ravi\nPassword: Ravi123");
}


/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
authDomain:"ravicardmaker.firebaseapp.com",
projectId:"ravicardmaker"
});
const db=firebase.firestore();

let rows=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
rows=[];
s.forEach(d=>rows.push({id:d.id,...d.data()}));
render();
});


/* MONTH */
const months=["All","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
months.forEach((m,i)=>{
let o=document.createElement("option");
o.value=i===0?"all":String(i).padStart(2,"0");
o.text=m;
month.appendChild(o);
});
month.value=String(new Date().getMonth()+1).padStart(2,"0");


/* HOURS */
function hoursCalc(i,o){
let a=new Date("2000 "+i),b=new Date("2000 "+o);
if(b<a)b.setDate(b.getDate()+1);
return ((b-a)/3600000).toFixed(2);
}


/* SAVE */
function save(){
let obj={
d:date.value,
i:inTime.value,
o:outTime.value,
p:post.value,
bg:bg.value,
font:font.value,
h:hoursCalc(inTime.value,outTime.value)
};

if(editId)
db.collection("attendance").doc(editId).update(obj);
else
db.collection("attendance").add(obj);

clearForm();
}
function clearForm(){editId=null}


/* EDIT */
function edit(id){
let r=rows.find(x=>x.id===id);
editId=id;
date.value=r.d;
inTime.value=r.i;
outTime.value=r.o;
post.value=r.p;
bg.value=r.bg;
font.value=r.font;
}


/* DELETE */
function del(id){
if(confirm("Delete?"))
db.collection("attendance").doc(id).delete();
}


/* RENDER */
function render(){
tbody.innerHTML="";
let m=month.value,s=search.value.toLowerCase();
let th=0,td=0;

rows.sort((a,b)=> new Date(a.d+" "+a.i)-new Date(b.d+" "+b.i));

rows.forEach(r=>{
if(m!=="all" && r.d.split("-")[1]!==m) return;
if(s && !r.p.toLowerCase().includes(s)) return;

td++; th+=+r.h;

tbody.innerHTML+=`
<tr style="background:${r.bg};color:${r.font}">
<td>${r.d}</td>
<td>${r.i}</td>
<td>${r.o}</td>
<td>${r.h}</td>
<td>${r.p}</td>
<td><button onclick="edit('${r.id}')">✏️</button></td>
<td><button onclick="del('${r.id}')">❌</button></td>
</tr>`;
});

duty.innerText=td;
hours.innerText=th.toFixed(2);
}


/* CSV */
function downloadCSV(){
let csv="Date,In,Out,Hours,Post\n";
rows.forEach(r=>csv+=`${r.d},${r.i},${r.o},${r.h},${r.p}\n`);
let blob=new Blob([csv]);
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="attendance.csv";
a.click();
}
</script>

</body>
</html>
