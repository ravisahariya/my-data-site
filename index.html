<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Attendance MASTER</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#667eea,#764ba2);
}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
justify-content:center;
align-items:center;
}

.loginCard{
background:#fff;
width:95%;
max-width:500px;
padding:35px;
border-radius:20px;
text-align:center;
box-shadow:0 15px 40px rgba(0,0,0,.3);
}

.loginCard h2{font-size:30px;margin-bottom:10px}

.loginCard input{
width:100%;
padding:12px;
margin:6px 0;
font-size:18px;
}

.loginCard button{
padding:10px 25px;
font-size:18px;
}

/* LIVE CLOCK */
.clockBox{
background:#f2f3ff;
padding:12px;
border-radius:10px;
margin-bottom:15px;
}

#liveDate{font-size:18px}
#liveDay{font-size:16px;color:#666}
#liveTime{font-size:26px;color:#2e7dff;font-weight:bold}

/* APP */
#app{display:none;height:100vh;flex-direction:column}

.top{
background:#fff;
padding:6px;
position:sticky;
top:0;
z-index:10;
}

.tableBox{
flex:1;
overflow:auto;
background:#fff;
}

.bottom{
background:#ffeaa7;
padding:8px;
font-weight:bold;
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#ffd9d9}

.logout{
background:red;color:#fff;border:none;padding:6px 10px
}
.secret{
cursor:pointer;color:#555;margin-top:10px
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="loginCard">

<h2>üîê Attendance Login</h2>

<div class="clockBox">
<div id="liveDate"></div>
<div id="liveDay"></div>
<div id="liveTime"></div>
</div>

<input id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">

<button onclick="login()">Login</button>

<div class="secret" onclick="openSecret()">üîí Secret</div>
</div>
</div>


<!-- SECRET BOX -->
<div id="secretBox" style="display:none;position:fixed;inset:0;background:#0008;justify-content:center;align-items:center">
<div style="background:#fff;padding:20px;border-radius:10px;width:300px">

<b>Current Username:</b> <span id="cu"></span><br>
<b>Current Password:</b> <span id="cp"></span><hr>

Old Password<br>
<input id="oldp"><br>
New Username<br>
<input id="newu"><br>
New Password<br>
<input id="newp"><br>
Confirm<br>
<input id="conf"><br><br>

<button onclick="changeCred()">OK</button>
<button onclick="secretBox.style.display='none'">Close</button>
</div>
</div>


<!-- APP -->
<div id="app">

<div class="top">
<b>‚òÅÔ∏è Attendance MASTER</b>
<button class="logout" onclick="logout()">Logout</button>

<br><br>

<input type="date" id="date">
<input type="time" id="inTime">
<input type="time" id="outTime">
<input id="post" placeholder="Post">

BG <input type="color" id="bg" value="#fffacd">
Font <input type="color" id="font" value="#000">

<button onclick="save()">Save</button>

<select id="monthFilter" onchange="render()"></select>
<button onclick="downloadCSV()">Excel</button>
<button onclick="print()">Print</button>
</div>

<div class="tableBox">
<table>
<thead>
<tr>
<th>Date</th><th>In</th><th>Out</th><th>Hours</th>
<th>Post</th><th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="bottom">
Total Duty: <span id="duty">0</span>
&nbsp;&nbsp;
Total Hours: <span id="hours">0</span>
</div>

</div>


<script>
/* CLOCK 24H */
function updateClock(){
const n=new Date();

liveDate.innerText=n.toLocaleDateString();
liveDay.innerText=n.toLocaleDateString('en',{weekday:'long'});

let h=String(n.getHours()).padStart(2,'0');
let m=String(n.getMinutes()).padStart(2,'0');
let s=String(n.getSeconds()).padStart(2,'0');

liveTime.innerText=h+":"+m+":"+s;
}
setInterval(updateClock,1000);
updateClock();

/* CREDENTIALS */
let creds=JSON.parse(localStorage.getItem("creds")) || {u:"Ravi",p:"Ravi123"};

/* LOGIN */
if(localStorage.getItem("login")) showApp();

function login(){
if(username.value===creds.u && password.value===creds.p){
localStorage.setItem("login","1");
showApp();
}else alert("Wrong login");
}

function logout(){
localStorage.removeItem("login");
location.reload();
}

function showApp(){
loginPage.style.display="none";
app.style.display="flex";
}

/* SECRET */
function openSecret(){
let y=prompt("Enter year");
if(y==="1995"){
secretBox.style.display="flex";
cu.innerText=creds.u;
cp.innerText=creds.p;
}
}

function changeCred(){
if(oldp.value!==creds.p) return alert("Wrong old");
if(newp.value!==conf.value) return alert("Mismatch");

creds={u:newu.value,p:newp.value};
localStorage.setItem("creds",JSON.stringify(creds));
alert("Changed");
secretBox.style.display="none";
}

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
projectId:"ravicardmaker"
});
const db=firebase.firestore();

let data=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
data=[];
s.forEach(d=>data.push({id:d.id,...d.data()}));
render();
});

/* MONTH */
for(let i=0;i<=12;i++){
let op=document.createElement("option");
op.value=i===0?"all":String(i).padStart(2,'0');
op.text=i===0?"All":new Date(0,i-1).toLocaleString('default',{month:'short'});
monthFilter.appendChild(op);
}

/* HOURS */
function calc(i,o){
let a=new Date("2000 "+i),b=new Date("2000 "+o);
if(b<a)b.setDate(b.getDate()+1);
return ((b-a)/3600000).toFixed(2);
}

/* SAVE */
function save(){
let obj={
d:date.value,i:inTime.value,o:outTime.value,
p:post.value,bg:bg.value,font:font.value,
h:calc(inTime.value,outTime.value)
};

if(editId) db.collection("attendance").doc(editId).update(obj);
else db.collection("attendance").add(obj);

}

/* EDIT */
function edit(id){
let r=data.find(x=>x.id===id);
editId=id;
date.value=r.d;
inTime.value=r.i;
outTime.value=r.o;
post.value=r.p;
bg.value=r.bg;
font.value=r.font;
}

/* DELETE */
function del(id){
if(confirm("Delete?"))
db.collection("attendance").doc(id).delete();
}

/* RENDER */
function render(){
tbody.innerHTML="";
let m=monthFilter.value;

let th=0,td=0;

[...data].sort((a,b)=> new Date(a.d+" "+a.i)-new Date(b.d+" "+b.i))
.forEach(r=>{
if(m!=="all" && r.d.split("-")[1]!==m) return;

td++; th+=+r.h;

tbody.innerHTML+=`
<tr style="background:${r.bg};color:${r.font}">
<td>${r.d}</td>
<td>${r.i}</td>
<td>${r.o}</td>
<td>${r.h}</td>
<td>${r.p}</td>
<td><button onclick="edit('${r.id}')">‚úèÔ∏è</button></td>
<td><button onclick="del('${r.id}')">‚ùå</button></td>
</tr>`;
});

duty.innerText=td;
hours.innerText=th.toFixed(2);
}

/* CSV */
function downloadCSV(){
let csv="Date,In,Out,Hours,Post\n";
data.forEach(r=>csv+=`${r.d},${r.i},${r.o},${r.h},${r.p}\n`);
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv]));
a.download="attendance.csv";
a.click();
}
</script>

</body>
 </html>
