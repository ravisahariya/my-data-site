<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance Master Data</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#6a82fb,#a18cd1);
}

/* LOGIN */
#loginPage{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.loginCard{
  background:#fff;
  width:90%;
  max-width:420px;
  padding:30px;
  border-radius:16px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
.loginCard h2{font-size:26px}
.loginCard input{
  width:100%;
  padding:12px;
  margin:8px 0;
  font-size:16px;
}
.loginCard button{
  width:100%;
  padding:12px;
  font-size:18px;
  margin-top:10px;
}
.secret{margin-top:10px;cursor:pointer}

/* APP */
#app{display:none;height:100vh;flex-direction:column}

/* HEADER */
.header{
  background:#1976d2;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:18px;
}

/* ENTRY FORM */
.formBox{
  background:#dbeeff;
  padding:8px;
}
.formBox input,.formBox select{
  padding:6px;
  margin:3px;
}

/* TABLE */
.tableBox{flex:1;overflow:auto;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#ffdede}

/* FOOTER */
.footer{
  background:#ffeb99;
  font-size:18px;
  font-weight:bold;
  padding:8px;
}

/* BUTTONS */
.logout{background:red;color:#fff;border:none;padding:6px 12px}
.editBtn{font-size:16px}
.delBtn{font-size:16px}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="loginCard">
    <h2>üîê Admin Attendance Login</h2>
    <div id="loginClock"></div>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="doLogin()">Admin Login</button>
    <div class="secret" onclick="openSecret()">üîí Secret</div>
  </div>
</div>

<!-- APP -->
<div id="app">

<div class="header">
  üìä ATTENDANCE MASTER DATA
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="formBox">
  <div id="runTime"></div>
  <input type="date" id="date">
  <input type="time" id="inTime">
  <input type="time" id="outTime">
  <input id="post" placeholder="Post">
  BG <input type="color" id="bg">
  Font <input type="color" id="font">
  <button onclick="save()">Save</button>
  <select id="month" onchange="render()"></select>
  <button onclick="download()">Excel</button>
  <button onclick="window.print()">Print</button>
</div>

<div class="tableBox">
<table>
<thead>
<tr>
<th>Date</th><th>In</th><th>Out</th><th>Hours</th><th>Post</th><th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="footer">
Total Duty: <span id="duty">0</span> |
Total Hours: <span id="hours">0</span>
</div>

</div>

<script>
/* CLOCK */
setInterval(()=>{
  const d=new Date();
  loginClock.innerText=d.toLocaleString();
  runTime.innerText=d.toLocaleString();
},1000);

/* LOGIN DATA */
let cred=JSON.parse(localStorage.getItem("cred")) || {u:"9823087",p:"7284"};

if(localStorage.getItem("login")) showApp();

function doLogin(){
  if(loginUser.value===cred.u && loginPass.value===cred.p){
    localStorage.setItem("login","1");
    showApp();
  }else alert("Wrong Login");
}
function logout(){
  localStorage.removeItem("login");
  location.reload();
}
function showApp(){
  loginPage.style.display="none";
  app.style.display="flex";
}

/* SECRET */
function openSecret(){
  if(prompt("Enter Secret")!=="1995")return;
  const nu=prompt("New Username",cred.u);
  const op=prompt("Old Password");
  if(op!==cred.p)return alert("Wrong Old Password");
  const np=prompt("New Password");
  const cp=prompt("Confirm Password");
  if(np!==cp)return alert("Mismatch");
  cred={u:nu,p:np};
  localStorage.setItem("cred",JSON.stringify(cred));
  alert("Updated");
}

/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
 authDomain:"ravicardmaker.firebaseapp.com",
 projectId:"ravicardmaker"
});
const db=firebase.firestore();
let data=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
 data=[];
 s.forEach(d=>data.push({id:d.id,...d.data()}));
 render();
});

/* MONTH */
["January","February","March","April","May","June","July","August","September","October","November","December"]
.forEach((m,i)=>{
 let o=document.createElement("option");
 o.value=i+1;o.text=m;month.appendChild(o);
});
month.value=new Date().getMonth()+1;

/* CALC */
function hours(i,o){
 let a=new Date("2000 "+i),b=new Date("2000 "+o);
 if(b<a)b.setDate(b.getDate()+1);
 return ((b-a)/36e5).toFixed(2);
}

/* SAVE */
function save(){
 let obj={
  date:date.value,
  in:inTime.value,
  out:outTime.value,
  h:hours(inTime.value,outTime.value),
  post:post.value,
  bg:bg.value,
  font:font.value
 };
 if(editId) db.collection("attendance").doc(editId).update(obj);
 else db.collection("attendance").add(obj);
 editId=null;
}

/* RENDER */
function render(){
 tbody.innerHTML="";
 let td=0,th=0;
 data.filter(r=>new Date(r.date).getMonth()+1==month.value)
 .forEach(r=>{
  td++;th+=+r.h;
  tbody.innerHTML+=`
  <tr style="background:${r.bg};color:${r.font}">
  <td>${r.date}</td>
  <td>${r.in}</td>
  <td>${r.out}</td>
  <td>${r.h}</td>
  <td>${r.post}</td>
  <td><button class="editBtn" onclick="edit('${r.id}');event.stopPropagation()">‚úèÔ∏è</button></td>
  <td><button class="delBtn" onclick="del('${r.id}');event.stopPropagation()">‚ùå</button></td>
  </tr>`;
 });
 duty.innerText=td;
 hours.innerText=th.toFixed(2);
}
function edit(id){
 let r=data.find(x=>x.id===id);
 editId=id;
 date.value=r.date;inTime.value=r.in;outTime.value=r.out;
 post.value=r.post;bg.value=r.bg;font.value=r.font;
}
function del(id){
 if(confirm("Delete?")) db.collection("attendance").doc(id).delete();
}

/* EXCEL */
function download(){
 let csv="Date,In,Out,Hours,Post\n";
 data.forEach(r=>csv+=`${r.date},${r.in},${r.out},${r.h},${r.post}\n`);
 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download="attendance.csv";
 a.click();
}
</script>

</body>
</html>
