<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Attendance MASTER</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}

/* HEADER */
header{
position:fixed;
top:0;
width:100%;
background:#1976d2;
color:#fff;
padding:12px;
text-align:center;
font-weight:bold;
z-index:2;
}

/* FOOTER */
footer{
position:fixed;
bottom:0;
width:100%;
background:#ffd54f;
padding:8px;
font-weight:bold;
}

/* TABLE SCROLL ONLY */
.table-box{
margin-top:120px;
margin-bottom:60px;
height:55vh;
overflow:auto;
}

/* LOGIN */
.login{
display:flex;
height:100vh;
justify-content:center;
align-items:center;
background:linear-gradient(45deg,#667eea,#764ba2);
}

.card{
background:white;
width:95%;
max-width:420px;
padding:30px;
border-radius:15px;
text-align:center;
box-shadow:0 0 20px #0003;
}

input,select,button{
padding:8px;
margin:4px;
}

table{
width:100%;
border-collapse:collapse;
background:white;
}

th,td{
border:1px solid #ccc;
padding:6px;
text-align:center;
}

th{background:#ffebee}
tr:hover{background:#e3f2fd}

</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div class="login" id="loginPage">
<div class="card">

<h2>üîê Login</h2>
<div id="clock"></div>

<input id="user"><br>
<input id="pass" type="password"><br>

<button onclick="login()">Login</button><br>

<input id="secret" placeholder="Secret">
<button onclick="openSecret()">üîí</button>

<div id="panel" style="display:none">
<hr>
User: <span id="showU"></span><br>
Pass: <span id="showP"></span><br>
<input id="newPass" placeholder="New password">
<button onclick="changePass()">Change</button>
</div>

</div>
</div>

<!-- ================= APP ================= -->
<div id="app" style="display:none">

<header>Attendance MASTER</header>

<div style="margin-top:60px;padding:5px;text-align:center">

<input type="date" id="date">
<input type="time" id="in">
<input type="time" id="out">

<select id="post">
<option>ETP</option>
<option>BORD 2</option>
<option>COE</option>
<option>ABEER</option>
</select>

BG <input type="color" id="bg">
Font <input type="color" id="font">

<button onclick="save()">Save</button>
<button onclick="downloadCSV()">Excel</button>
<button onclick="window.print()">Print</button>

<select id="month" onchange="filterMonth()"></select>

<button onclick="logout()">Logout</button>
</div>

<div class="table-box">
<table id="tbl">
<thead>
<tr>
<th>Date</th><th>In</th><th>Out</th>
<th>Hours</th><th>Post</th>
<th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<footer>
Total Duty: <span id="duty">0</span> |
Total Hours: <span id="hours">0</span>
</footer>

</div>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<script type="module">

/* ========= üî• Firebase CONFIG (APNA DALNA) ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX",
  projectId: "XXXX"
};

const appF = initializeApp(firebaseConfig);
const db = getFirestore(appF);

/* ========= LOGIN ========= */
let userData = JSON.parse(localStorage.getItem("userData")) || {u:"admin",p:"1234"};
user.value=userData.u;
pass.value=userData.p;

setInterval(()=>clock.innerText=new Date().toLocaleString(),1000);

window.login=()=>{
 if(user.value==userData.u && pass.value==userData.p){
  loginPage.style.display="none";
  app.style.display="block";
  load();
 }else alert("Wrong login");
}

window.openSecret=()=>{
 if(secret.value=="1995"){
  panel.style.display="block";
  showU.innerText=userData.u;
  showP.innerText=userData.p;
 }
}

window.changePass=()=>{
 userData.p=newPass.value;
 localStorage.setItem("userData",JSON.stringify(userData));
 alert("Changed");
 location.reload();
}

window.logout=()=>location.reload();

/* ========= ENTRY ========= */

function calcHours(a,b){
 let s=new Date("2000 "+a);
 let e=new Date("2000 "+b);
 if(e<s)e.setDate(e.getDate()+1); // night shift
 return ((e-s)/3600000).toFixed(2);
}

window.save=async()=>{
 let h=calcHours(in.value,out.value);

 await addDoc(collection(db,"att"),{
  date:date.value,
  in:in.value,
  out:out.value,
  hours:h,
  post:post.value,
  bg:bg.value,
  font:font.value
 });

 load();
}

/* ========= LOAD TABLE ========= */

async function load(){
 let snap=await getDocs(collection(db,"att"));
 let tb=tbl.querySelector("tbody");
 tb.innerHTML="";
 let total=0,c=0;

 snap.forEach(d=>{
  let r=d.data();
  total+=parseFloat(r.hours);
  c++;

  tb.innerHTML+=`
  <tr style="background:${r.bg};color:${r.font}">
  <td>${r.date}</td>
  <td>${r.in}</td>
  <td>${r.out}</td>
  <td>${r.hours}</td>
  <td>${r.post}</td>
  <td><button onclick="del('${d.id}')">‚úèÔ∏è</button></td>
  <td><button onclick="del('${d.id}')">‚ùå</button></td>
  </tr>`
 });

 duty.innerText=c;
 hours.innerText=total.toFixed(2);
}

window.del=async(id)=>{
 if(confirm("Delete?")){
  await deleteDoc(doc(db,"att",id));
  load();
 }
}

/* ========= MONTH FILTER ========= */

let months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
months.forEach((m,i)=>{
 month.innerHTML+=`<option value="${i}">${m}</option>`;
});
month.value=new Date().getMonth();

/* ========= CSV ========= */
window.downloadCSV=()=>{
 let rows=[...tbl.rows];
 let csv=[...rows].map(r=>[...r.cells].map(c=>c.innerText).join(",")).join("\n");
 let a=document.createElement("a");
 a.href="data:text/csv;charset=utf-8,"+csv;
 a.download="attendance.csv";
 a.click();
}

</script>
</body>
</html>
