<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Attendance MASTER</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
justify-content:center;
align-items:center;
background:linear-gradient(135deg,#5f72ff,#9b23ea);
}

.card{
background:#fff;
width:95%;
max-width:520px;
padding:55px;
border-radius:25px;
text-align:center;
box-shadow:0 20px 40px rgba(0,0,0,.3);
}

.card h2{font-size:32px}
.card input{width:100%;padding:14px;font-size:18px;margin:8px 0}
.card button{width:100%;padding:14px;font-size:18px}

#clock{
font-weight:bold;
color:#1976d2;
margin-bottom:10px;
}

/* APP */
#app{display:none;height:100vh;flex-direction:column}

/* HEADER */
header{
background:#1976d2;
color:#fff;
padding:10px;
display:flex;
justify-content:space-between;
font-weight:bold;
}

.logout{
background:red;
color:#fff;
border:none;
padding:6px 12px;
}

/* ENTRY FORM BLUE */
.form{
background:#1976d2;
padding:6px;
display:flex;
flex-wrap:wrap;
gap:5px;
}

.form input,.form select,.form button{
padding:6px;
}

/* TABLE */
.tableBox{flex:1;overflow:auto;background:#fff}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#ffd9d9}

.night{background:#d8ecff}

/* FOOTER */
footer{
background:#ffe082;
padding:8px;
font-weight:bold;
position:sticky;
bottom:0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="card">
<h2>üîê Attendance Login</h2>
<div id="clock"></div>

<input id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">

<button onclick="login()">Login</button>

<div onclick="secret()">üîí Secret</div>
</div>
</div>

<!-- APP -->
<div id="app">

<header>
Attendance MASTER
<button class="logout" onclick="logout()">Logout</button>
</header>

<!-- ENTRY FORM -->
<div class="form">
<input type="date" id="date">
<input type="time" id="inTime">
<input type="time" id="outTime">
<input id="post" placeholder="Post">

BG <input type="color" id="bg">
Font <input type="color" id="font">

<button onclick="save()">Save</button>

<select id="monthFilter" onchange="render()"></select>

<button onclick="download()">Excel</button>
<button onclick="window.print()">Print</button>
</div>

<!-- TABLE -->
<div class="tableBox">
<table>
<thead>
<tr>
<th>Date</th><th>In</th><th>Out</th><th>Hours</th><th>Post</th><th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<footer>
Total Duty: <span id="duty">0</span> |
Total Hours: <span id="hours">0</span>
</footer>

</div>


<script>

/* CLOCK */
setInterval(()=>{
clock.innerText=new Date().toLocaleString();
},1000);

/* LOGIN DATA */
let user=localStorage.u||"Ravi";
let pass=localStorage.p||"Ravi123";

if(localStorage.login) showApp();

function login(){
if(username.value===user && password.value===pass){
localStorage.login=1;
showApp();
}else alert("Wrong login");
}

function logout(){
localStorage.removeItem("login");
location.reload();
}

function showApp(){
loginPage.style.display="none";
app.style.display="flex";
}

/* SECRET (NO SHOW) */
function secret(){
let y=prompt("Enter year");
if(y!=="1995") return;

let nu=prompt("New username",user);
let np=prompt("New password",pass);

user=nu;
pass=np;

localStorage.u=nu;
localStorage.p=np;
}

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
projectId:"ravicardmaker"
});

const db=firebase.firestore();

let data=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
data=[];
s.forEach(d=>data.push({id:d.id,...d.data()}));
render();
});

/* MONTH DROPDOWN */
const months=["All","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
months.forEach((m,i)=>{
let o=document.createElement("option");
o.value=i;
o.text=m;
monthFilter.appendChild(o);
});

/* AUTO CURRENT MONTH */
monthFilter.value=new Date().getMonth()+1;

/* HOURS */
function calc(i,o){
let a=new Date("2000 "+i),b=new Date("2000 "+o);
if(b<a)b.setDate(b.getDate()+1);
return ((b-a)/3600000).toFixed(2);
}

/* SAVE */
function save(){
let obj={
d:date.value,
i:inTime.value,
o:outTime.value,
p:post.value,
bg:bg.value,
font:font.value
};

obj.h=calc(obj.i,obj.o);

if(editId)
db.collection("attendance").doc(editId).update(obj);
else
db.collection("attendance").add(obj);
}

/* RENDER */
function render(){
tbody.innerHTML="";

let m=monthFilter.value;
let td=0,th=0;

data.sort((a,b)=> new Date(a.d+" "+a.i)-new Date(b.d+" "+b.i))
.forEach(r=>{

if(m!=0 && parseInt(r.d.split("-")[1])!=m) return;

td++;
th+=+r.h;

let night=(r.i>r.o);

tbody.innerHTML+=`
<tr class="${night?'night':''}" style="background:${r.bg};color:${r.font}">
<td>${r.d}</td>
<td>${r.i}</td>
<td>${r.o}</td>
<td>${r.h}</td>
<td>${r.p}</td>
<td><button onclick="edit('${r.id}')">‚úèÔ∏è</button></td>
<td><button onclick="del('${r.id}')">‚ùå</button></td>
</tr>`;
});

duty.innerText=td;
hours.innerText=th.toFixed(2);
}

/* EDIT */
function edit(id){
let r=data.find(x=>x.id===id);
editId=id;
date.value=r.d;
inTime.value=r.i;
outTime.value=r.o;
post.value=r.p;
bg.value=r.bg;
font.value=r.font;
}

/* DELETE */
function del(id){
if(confirm("Delete?"))
db.collection("attendance").doc(id).delete();
}

/* CSV */
function download(){
let csv="Date,In,Out,Hours,Post\n";
data.forEach(r=>csv+=`${r.d},${r.i},${r.o},${r.h},${r.p}\n`);
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv]));
a.download="attendance.csv";
a.click();
}

</script>

</body>
</html>
