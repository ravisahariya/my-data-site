<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Master Attendance Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#eaeaea}
.hidden{display:none}

/* LOGIN */
#loginBox{
  max-width:380px;margin:70px auto;background:#fff;
  padding:25px;border-radius:15px;
  box-shadow:0 0 15px rgba(0,0,0,.3);text-align:center
}
#loginBox input{width:100%;padding:12px;margin:8px 0}
#loginBox button{width:100%;padding:12px;background:#0d6efd;color:#fff;border:none;border-radius:10px}

/* HEADER */
.header{
  background:#0d6efd;color:#fff;padding:12px;
  display:flex;justify-content:space-between;align-items:center;
  font-size:22px
}
.logout{background:red;color:#fff;border:none;padding:8px 12px;border-radius:8px}

/* LIVE DATE TIME */
#liveDateTime{
  text-align:center;
  padding:8px;
  background:#fff;
  font-weight:bold;
  border-bottom:1px solid #ccc;
}

/* SUMMARY */
.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px}
.box{padding:12px;color:#fff;border-radius:10px;text-align:center;font-weight:bold}
.box span{display:block;font-size:26px}
.g{background:#198754}
.o{background:#fd7e14}
.p{background:#6f42c1}

/* FORM */
.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;padding:10px}
.form input,.form select{padding:8px}
.add{background:#0d6efd;color:#fff;border:none;border-radius:8px}

/* TABLE */
.tableWrap{margin:10px;max-height:60vh;overflow:auto;border-radius:10px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:center}
th{background:#f1f1f1;position:sticky;top:0}
td.dateCol{white-space:nowrap;font-weight:bold}

/* OT */
.otRow{background:#fff3cd}

/* ACTION ICONS */
.action i{cursor:pointer;font-size:18px;opacity:.3;margin:0 6px}
tr:hover .action i{opacity:1}
.edit{color:#ff9800}
.del{color:#f44336}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">LOGIN</button>
</div>

<!-- MAIN PAGE -->
<div id="main" class="hidden">

  <div class="header">
    Master Attendance Sheet
    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <!-- LIVE DATE TIME -->
  <div id="liveDateTime"></div>

  <div class="summary">
    <div class="box g">Total Days<span id="tDays">0</span></div>
    <div class="box o">Total Hours<span id="tHours">0</span></div>
    <div class="box p">OT<span id="tOT">0</span></div>
  </div>

  <div class="form">
    <input type="date" id="date">
    <input type="time" id="inTime">
    <input type="time" id="outTime">
    <input id="post" placeholder="Post">
    <select id="monthFilter" onchange="render()"></select>
    <button class="add" onclick="addEntry()">ADD</button>
    <button class="add" onclick="downloadCSV()">Download</button>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>In</th><th>Out</th>
          <th>Hours</th><th>Post</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<script>
/* ---------------- FIREBASE ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
  authDomain: "ravicardmaker.firebaseapp.com",
  projectId: "ravicardmaker",
  storageBucket: "ravicardmaker.firebasestorage.app",
  messagingSenderId: "125321734592",
  appId: "1:125321734592:web:eaba2d7477376694134025"
});
const db = firebase.firestore();

/* ---------------- LOGIN ---------------- */
const USERNAME="9823087", PASSWORD="7284";

function login(){
  if(user.value===USERNAME && pass.value===PASSWORD){
    localStorage.setItem("login","yes");
    showMain();
  } else alert("Wrong Login");
}

function logout(){
  localStorage.removeItem("login");
  location.reload();
}

if(localStorage.getItem("login")==="yes") showMain();

/* ---------------- SHOW MAIN ---------------- */
function showMain(){
  loginBox.classList.add("hidden");
  main.classList.remove("hidden");
  initMonths();
  autoDate();
  startLiveDateTime();
  loadData();
}

/* ---------------- LIVE DATE TIME ---------------- */
function startLiveDateTime(){
  function update(){
    const now=new Date();
    const d=now.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
    let h=now.getHours(),m=now.getMinutes().toString().padStart(2,"0"),
        s=now.getSeconds().toString().padStart(2,"0"),
        ap=h>=12?"PM":"AM";
    h=h%12||12;
    liveDateTime.innerHTML=`Date: ${d} | Time: ${h}:${m}:${s} ${ap}`;
  }
  update();
  setInterval(update,1000);
}

/* ---------------- MONTHS ---------------- */
function initMonths(){
  const months=["All Months","January","February","March","April","May","June","July","August","September","October","November","December"];
  monthFilter.innerHTML="";
  months.forEach((m,i)=>{
    const o=document.createElement("option");
    o.value=i;o.text=m;monthFilter.appendChild(o);
  });
  monthFilter.value=new Date().getMonth()+1;
}

/* ---------------- DATE ---------------- */
function autoDate(){
  date.value=new Date().toISOString().slice(0,10);
}

/* ---------------- TIME FORMAT ---------------- */
function ampm(t){
  if(!t)return"-";
  let [h,m]=t.split(":");h=parseInt(h);
  let ap=h>=12?"PM":"AM";h=h%12||12;
  return `${h}:${m} ${ap}`;
}

/* ---------------- ADD ENTRY ---------------- */
function addEntry(){
  const d=date.value,i=inTime.value,o=outTime.value,p=post.value;
  if(!d||!p) return alert("Date & Post required");

  let start=new Date(d+"T"+i);
  let end=new Date(d+"T"+o);
  let night=false;
  if(i&&o&&end<start){end.setDate(end.getDate()+1);night=true;}
  let hrs=i&&o?((end-start)/3600000).toFixed(2):"0.00";

  db.collection("attendance").add({date:d,in:i,out:o,hours:hrs,post:p,night});
  inTime.value=outTime.value=post.value="";
}

/* ---------------- LOAD DATA ---------------- */
let allData=[];
function loadData(){
  db.collection("attendance").orderBy("date")
    .onSnapshot(s=>{
      allData=[];
      s.forEach(d=>allData.push({id:d.id,...d.data()}));
      render();
    });
}

/* ---------------- RENDER ---------------- */
function render(){
  if(allData.length===0){
    tbody.innerHTML="";
    tDays.innerText=tHours.innerText=tOT.innerText=0;
    return;
  }

  const sel=parseInt(monthFilter.value);
  let html="",hrs=0;
  const dates=new Set(),otDates=new Set();
  const byDate={};

  allData.forEach(r=>{
    if(!byDate[r.date])byDate[r.date]=[];
    byDate[r.date].push(r);
  });

  allData.forEach(r=>{
    const m=new Date(r.date).getMonth()+1;
    if(sel!==0 && m!==sel) return;

    hrs+=+r.hours;
    dates.add(r.date);
    const isOT=(byDate[r.date].length>1 && r.night);
    if(isOT) otDates.add(r.date);

    html+=`
    <tr class="${isOT?'otRow':''}">
      <td class="dateCol">${r.date}</td>
      <td>${ampm(r.in)}</td>
      <td>${ampm(r.out)}</td>
      <td>${r.hours}</td>
      <td>${r.post}</td>
      <td class="action">
        <i class="edit" onclick="editEntry('${r.id}')">‚úèÔ∏è</i>
        <i class="del" onclick="delEntry('${r.id}')">üóëÔ∏è</i>
      </td>
    </tr>`;
  });

  tbody.innerHTML=html;
  tDays.innerText=dates.size;
  tHours.innerText=hrs.toFixed(2);
  tOT.innerText=otDates.size;
}

/* ---------------- EDIT / DELETE ---------------- */
function editEntry(id){
  const r=allData.find(x=>x.id===id);
  date.value=r.date;inTime.value=r.in;outTime.value=r.out;post.value=r.post;
}
function delEntry(id){
  if(confirm("Delete entry?"))
    db.collection("attendance").doc(id).delete();
}

/* ---------------- DOWNLOAD ---------------- */
function downloadCSV(){
  let csv="Date,In,Out,Hours,Post\n";
  allData.forEach(r=>csv+=`${r.date},${r.in},${r.out},${r.hours},${r.post}\n`);
  const a=document.createElement("a");
  a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
  a.download="attendance.csv";
  a.click();
}
</script>
</body>
</html>
