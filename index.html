<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Master Data</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#6a11cb,#2575fc);
}

/* ---------------- LOGIN ---------------- */
#loginPage{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.loginCard{
  width:95%;
  max-width:420px;
  background:#fff;
  border-radius:16px;
  padding:30px;
  text-align:center;
  box-shadow:0 15px 30px rgba(0,0,0,.35);
}
.loginCard h2{
  font-size:26px;
  margin-bottom:10px;
}
#loginTime{
  font-size:16px;
  color:#1e40af;
  margin-bottom:15px;
}
.loginCard input{
  width:100%;
  padding:12px;
  font-size:18px;
  margin:8px 0;
}
.loginCard button{
  width:100%;
  padding:12px;
  font-size:18px;
  margin-top:10px;
  cursor:pointer;
}
.secretBtn{
  margin-top:10px;
  background:#f1f5f9;
}

/* ---------------- APP LAYOUT ---------------- */
#app{display:none;height:100vh;flex-direction:column}

/* HEADER */
.header{
  background:#0b5ed7;
  color:#fff;
  padding:10px;
  font-size:20px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logout{
  background:red;
  color:#fff;
  border:none;
  padding:6px 12px;
  font-size:16px;
  cursor:pointer;
}

/* ENTRY FORM */
.formBox{
  background:#dbeafe;
  padding:8px;
}
.formBox input,.formBox select,.formBox button{
  padding:6px;
  margin:3px;
}
#runningTime{
  font-weight:bold;
  margin-bottom:5px;
}

/* TABLE */
.tableWrap{
  flex:1;
  overflow:auto;
  background:#fff;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th{background:#ffd6d6}

/* FOOTER */
.footer{
  background:#facc15;
  padding:8px;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="loginCard">
    <h2>üîê Admin Attendance Login</h2>
    <div id="loginTime"></div>
    <input id="u" placeholder="Username">
    <input id="p" type="password" placeholder="Password">
    <button onclick="login()">Admin</button>
    <button class="secretBtn" onclick="openSecret()">üîí Secret</button>
  </div>
</div>

<!-- APP -->
<div id="app">

  <div class="header">
    üìä ATTENDANCE MASTER DATA
    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <div class="formBox">
    <div id="runningTime"></div>

    <input type="date" id="date">
    <input type="time" id="inTime">
    <input type="time" id="outTime">
    <input id="post" placeholder="Post">

    BG <input type="color" id="bg" value="#e0f2fe">
    Font <input type="color" id="font" value="#000000">

    <button onclick="save()">Save</button>

    <select id="month"></select>
    <button onclick="downloadCSV()">Excel</button>
    <button onclick="window.print()">Print</button>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>In</th><th>Out</th><th>Hours</th>
          <th>Post</th><th>Edit</th><th>Delete</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    Total Duty: <span id="duty">0</span> |
    Total Hours: <span id="hours">0</span>
  </div>

</div>

<script>
/* -------- LOGIN SYSTEM -------- */
let creds = JSON.parse(localStorage.getItem("creds")) || {u:"9823087",p:"7284"};
if(localStorage.getItem("login")) showApp();

function login(){
  if(u.value===creds.u && p.value===creds.p){
    localStorage.setItem("login","1");
    showApp();
  }else alert("Wrong Login");
}
function logout(){
  localStorage.removeItem("login");
  location.reload();
}
function showApp(){
  loginPage.style.display="none";
  app.style.display="flex";
}

/* LOGIN CLOCK */
setInterval(()=>{
  loginTime.innerText = new Date().toLocaleString();
},1000);

/* -------- SECRET -------- */
function openSecret(){
  let s=prompt("Enter Secret Code");
  if(s==="1995"){
    let nu=prompt("New Username",creds.u);
    let np=prompt("New Password");
    let cp=prompt("Confirm Password");
    if(np && np===cp){
      creds={u:nu,p:np};
      localStorage.setItem("creds",JSON.stringify(creds));
      alert("Updated Successfully");
    }
  }
}

/* -------- FIREBASE -------- */
firebase.initializeApp({
  apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
  authDomain:"ravicardmaker.firebaseapp.com",
  projectId:"ravicardmaker"
});
const db=firebase.firestore();
let data=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
  data=[];
  s.forEach(d=>data.push({id:d.id,...d.data()}));
  render();
});

/* -------- MONTH DROPDOWN -------- */
const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
months.forEach((m,i)=>{
  let o=document.createElement("option");
  o.value=i;
  o.text=m;
  month.appendChild(o);
});
month.value=new Date().getMonth();

/* -------- RUNNING TIME -------- */
setInterval(()=>{
  runningTime.innerText="üïí "+new Date().toLocaleString();
},1000);

/* -------- HOURS CALC -------- */
function calc(i,o){
  let a=new Date("2000-01-01 "+i);
  let b=new Date("2000-01-01 "+o);
  if(b<a) b.setDate(b.getDate()+1);
  return ((b-a)/3600000).toFixed(2);
}

/* -------- SAVE -------- */
function save(){
  let obj={
    date:date.value,
    in:inTime.value,
    out:outTime.value,
    post:post.value,
    bg:bg.value,
    font:font.value,
    h:calc(inTime.value,outTime.value)
  };
  if(editId) db.collection("attendance").doc(editId).update(obj);
  else db.collection("attendance").add(obj);
  editId=null;
}

/* -------- EDIT / DELETE -------- */
function edit(id){
  let r=data.find(x=>x.id===id);
  editId=id;
  date.value=r.date;
  inTime.value=r.in;
  outTime.value=r.out;
  post.value=r.post;
  bg.value=r.bg;
  font.value=r.font;
}
function del(id){
  if(confirm("Delete?"))
    db.collection("attendance").doc(id).delete();
}

/* -------- RENDER -------- */
function render(){
  tbody.innerHTML="";
  let td=0,th=0;
  let m=Number(month.value);

  data.forEach(r=>{
    if(new Date(r.date).getMonth()!==m) return;
    td++; th+=Number(r.h);
    tbody.innerHTML+=`
      <tr style="background:${r.bg};color:${r.font}">
        <td>${r.date}</td>
        <td>${r.in}</td>
        <td>${r.out}</td>
        <td>${r.h}</td>
        <td>${r.post}</td>
        <td><button onclick="edit('${r.id}')">‚úèÔ∏è</button></td>
        <td><button onclick="del('${r.id}')">‚ùå</button></td>
      </tr>`;
  });
  duty.innerText=td;
  hours.innerText=th.toFixed(2);
}

/* -------- CSV -------- */
function downloadCSV(){
  let csv="Date,In,Out,Hours,Post\n";
  data.forEach(r=>csv+=`${r.date},${r.in},${r.out},${r.h},${r.post}\n`);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="attendance.csv";
  a.click();
}
</script>

</body>
</html>
