<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Attendance MASTER FINAL</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
#app{display:flex;flex-direction:column;height:100vh}
.top{display:flex;justify-content:space-between;padding:8px}
.logout{background:#f44336;color:#fff;border:none;padding:6px 12px}

.form{display:flex;flex-wrap:wrap;gap:5px;padding:6px}
input,select,button{padding:6px}

.tableBox{flex:1;overflow:auto;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#ffd9d9}
.total{background:#ffeaa7;font-weight:bold}
</style>
</head>

<body>

<div id="app">

<div class="top">
<h3>☁️ Attendance MASTER</h3>
<button class="logout" onclick="logout()">Logout</button>
</div>

<div class="form">
<input type="date" id="date">
<input type="time" id="inTime">
<input type="time" id="outTime">
<input id="post" placeholder="Post">

BG <input type="color" id="bg" value="#fffacd">
Font <input type="color" id="font" value="#000000">

<button onclick="save()">Save</button>
<button onclick="clearForm()">Clear</button>

<select id="monthFilter" onchange="render()">
<option value="all">All</option>
<option value="01">Jan</option><option value="02">Feb</option>
<option value="03">Mar</option><option value="04">Apr</option>
<option value="05">May</option><option value="06">Jun</option>
<option value="07">Jul</option><option value="08">Aug</option>
<option value="09">Sep</option><option value="10">Oct</option>
<option value="11">Nov</option><option value="12">Dec</option>
</select>

<input id="search" placeholder="Search" onkeyup="render()">

<button onclick="downloadCSV()">Excel</button>
<button onclick="window.print()">Print</button>
</div>

<div class="tableBox">
<table>
<thead>
<tr>
<th>Date</th><th>In</th><th>Out</th><th>Hours</th><th>Post</th><th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
<tfoot>
<tr class="total">
<td>Total Duty: <span id="duty">0</span></td>
<td colspan="2">Total Hours</td>
<td id="hours">0</td>
<td colspan="3"></td>
</tr>
</tfoot>
</table>
</div>

</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
 authDomain:"ravicardmaker.firebaseapp.com",
 projectId:"ravicardmaker"
});
const db=firebase.firestore();

let data=[];
let editId=null;

db.collection("attendance").onSnapshot(s=>{
 data=[];
 s.forEach(d=>data.push({id:d.id,...d.data()}));
 render();
});

/* HOURS CALC */
function calc(i,o){
 let a=new Date("2000 "+i),b=new Date("2000 "+o);
 if(b<a) b.setDate(b.getDate()+1);
 return ((b-a)/3600000).toFixed(2);
}

/* SAVE */
function save(){
 let obj={
  d:date.value,
  i:inTime.value,
  o:outTime.value,
  p:post.value,
  bg:bg.value,
  font:font.value,
  h:calc(inTime.value,outTime.value)
 };

 if(editId){
  db.collection("attendance").doc(editId).update(obj);
 }else{
  db.collection("attendance").add(obj);
 }

 clearForm();
}

function clearForm(){
 editId=null;
 date.value="";inTime.value="";outTime.value="";post.value="";
}

/* EDIT */
function edit(id){
 let r=data.find(x=>x.id===id);
 editId=id;
 date.value=r.d;
 inTime.value=r.i;
 outTime.value=r.o;
 post.value=r.p;
 bg.value=r.bg;
 font.value=r.font;
 window.scrollTo(0,0);
}

/* DELETE */
function del(id){
 if(confirm("Delete entry?"))
  db.collection("attendance").doc(id).delete();
}

/* ⭐⭐⭐ AUTO DATE SORT FIX HERE ⭐⭐⭐ */
function render(){

 tbody.innerHTML="";

 let month=monthFilter.value;
 let s=search.value.toLowerCase();

 /* DATE SORT */
 let sorted=[...data].sort((a,b)=> new Date(a.d)-new Date(b.d));

 let totalH=0,totalD=0;

 sorted.forEach(r=>{

  if(month!=="all" && r.d.split("-")[1]!==month) return;
  if(s && !(r.d+r.p).toLowerCase().includes(s)) return;

  totalH+=+r.h;
  totalD++;

  tbody.innerHTML+=`
  <tr style="background:${r.bg};color:${r.font}">
  <td>${r.d}</td>
  <td>${r.i}</td>
  <td>${r.o}</td>
  <td>${r.h}</td>
  <td>${r.p}</td>
  <td><button onclick="edit('${r.id}')">✏️</button></td>
  <td><button onclick="del('${r.id}')">❌</button></td>
  </tr>`;
 });

 duty.innerText=totalD;
 hours.innerText=totalH.toFixed(2);
}

/* CSV */
function downloadCSV(){
 let csv="Date,In,Out,Hours,Post\n";
 data.forEach(r=>csv+=`${r.d},${r.i},${r.o},${r.h},${r.p}\n`);
 let blob=new Blob([csv]);
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="attendance.csv";
 a.click();
}

function logout(){ location.reload(); }
</script>

</body>
</html>
