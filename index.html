<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Attendance MASTER</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
justify-content:center;
align-items:center;
background:linear-gradient(135deg,#667eea,#764ba2);
}

.loginCard{
background:#fff;
width:95%;
max-width:520px;
padding:40px;
border-radius:18px;
text-align:center;
box-shadow:0 12px 30px rgba(0,0,0,.35);
}

.bigClock{
font-size:18px;
font-weight:bold;
margin-bottom:15px;
}

/* APP */
#app{
display:none;
height:100vh;
flex-direction:column;
}

/* HEADER */
.topFixed{
position:sticky;
top:0;
background:#fff;
padding:8px;
box-shadow:0 2px 6px rgba(0,0,0,.2);
z-index:5;
}

/* FOOTER */
.bottomFixed{
position:sticky;
bottom:0;
background:#ffeaa7;
padding:8px;
font-weight:bold;
}

/* TABLE */
.tableBox{
flex:1;
overflow:auto;
background:#fff;
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#ffd9d9}

/* night highlight */
.night{
background:#d0e6ff !important;
}

button{padding:6px}
.logout{background:#f44336;color:#fff;border:none}
.secret{cursor:pointer;margin-top:10px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="loginCard">

<div class="bigClock" id="clock"></div>

<h2>üîê Attendance Login</h2>

<input id="username" placeholder="Username"><br><br>
<input type="password" id="password" placeholder="Password"><br><br>

<button onclick="doLogin()">Login</button>

<div class="secret" onclick="secretBox()">üîí Secret</div>
</div>
</div>


<!-- APP -->
<div id="app">

<div class="topFixed">
<b>‚òÅÔ∏è Attendance MASTER</b>
<button class="logout" onclick="logout()">Logout</button>
<br><br>

<input type="date" id="date">
<input type="time" id="inTime">
<input type="time" id="outTime">
<input id="post" placeholder="Post">

BG <input type="color" id="bg" value="#ffffff">
Font <input type="color" id="font" value="#000000">

<button onclick="save()">Save</button>

<select id="monthFilter" onchange="render()"></select>

<button onclick="downloadCSV()">Excel</button>
<button onclick="window.print()">Print</button>

</div>


<div class="tableBox">
<table>
<thead>
<tr>
<th>Date</th>
<th>In</th>
<th>Out</th>
<th>Hours</th>
<th>Post</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>


<div class="bottomFixed">
Total Duty: <span id="duty">0</span>
&nbsp;&nbsp;&nbsp;
Total Hours: <span id="hours">0</span>
</div>

</div>



<script>

/* CLOCK */
setInterval(()=>{
 let d=new Date();
 let day=d.toLocaleDateString('en-IN',{weekday:'long'});
 let date=d.toLocaleDateString('en-IN');
 let time=d.toLocaleTimeString('en-IN',{hour12:false});
 clock.innerText=`${day} | ${date} | ${time}`;
},1000);


/* LOGIN */
let USER="Ravi";
let PASS="Ravi123";

if(localStorage.login) showApp();

function doLogin(){
 if(username.value===USER && password.value===PASS){
  localStorage.login=1;
  showApp();
 }else alert("Wrong login");
}

function logout(){
 localStorage.removeItem("login");
 location.reload();
}

function showApp(){
 loginPage.style.display="none";
 app.style.display="flex";
}

/* SECRET */
function secretBox(){
 let y=prompt("Enter 1995");
 if(y==="1995"){
  alert(`Username: ${USER}\nPassword: ${PASS}`);
 }
}


/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyD71mpolAsmejtU2icecQQcX07iCW_is0Y",
 projectId:"ravicardmaker"
});

const db=firebase.firestore();

let data=[],editId=null;

db.collection("attendance").onSnapshot(s=>{
 data=[];
 s.forEach(d=>data.push({id:d.id,...d.data()}));
 render();
});


/* CURRENT MONTH DEFAULT */
let now=new Date();
let currentMonth=String(now.getMonth()+1).padStart(2,"0");

["All","01","02","03","04","05","06","07","08","09","10","11","12"]
.forEach(m=>{
 let o=document.createElement("option");
 o.value=m==="All"?"all":m;
 o.text=m==="All"?"All":m;
 monthFilter.appendChild(o);
});

monthFilter.value=currentMonth;


/* HOURS */
function calc(i,o){
 let a=new Date("2000 "+i);
 let b=new Date("2000 "+o);
 if(b<a)b.setDate(b.getDate()+1);
 return ((b-a)/3600000).toFixed(2);
}

/* AM PM */
function ampm(t){
 let [h,m]=t.split(":");
 let d=new Date();
 d.setHours(h,m);
 return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}


/* SAVE */
function save(){
 let obj={
  d:date.value,
  i:inTime.value,
  o:outTime.value,
  p:post.value,
  bg:bg.value,
  font:font.value,
  h:calc(inTime.value,outTime.value)
 };

 if(editId) db.collection("attendance").doc(editId).update(obj);
 else db.collection("attendance").add(obj);

}


/* RENDER */
function render(){

 tbody.innerHTML="";
 let month=monthFilter.value;

 let sorted=[...data].sort((a,b)=> new Date(a.d+" "+a.i)-new Date(b.d+" "+b.i));

 let th=0,td=0;

 sorted.forEach(r=>{

  if(month!=="all" && r.d.split("-")[1]!==month) return;

  td++; th+=+r.h;

  let night = (r.i > r.o); // night shift

  tbody.innerHTML+=`
  <tr class="${night?'night':''}" style="color:${r.font}">
  <td>${r.d}</td>
  <td>${ampm(r.i)}</td>
  <td>${ampm(r.o)}</td>
  <td>${r.h}</td>
  <td>${r.p}</td>
  <td><button onclick="edit('${r.id}')">‚úèÔ∏è</button></td>
  <td><button onclick="del('${r.id}')">‚ùå</button></td>
  </tr>`;
 });

 duty.innerText=td;
 hours.innerText=th.toFixed(2);
}


/* DELETE */
function del(id){
 if(confirm("Delete?"))
  db.collection("attendance").doc(id).delete();
}


/* CSV */
function downloadCSV(){
 let csv="Date,In,Out,Hours,Post\n";
 data.forEach(r=>csv+=`${r.d},${r.i},${r.o},${r.h},${r.p}\n`);
 let blob=new Blob([csv]);
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="attendance.csv";
 a.click();
}

</script>

</body>
</html>
